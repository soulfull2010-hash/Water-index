<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Health Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;500;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root {
      --primary: #20b7d5;
      --accent: #43cea2;
      --secondary: #155271;
      --bubble: #0093E9;
      --good: #2e7d32; --warn: #f9a825; --bad: #c62828;
      --card: #FFFFFF;
      --bg-gradient: linear-gradient(135deg, #43cea2 0, #185a9d 100%);
    }
    body { margin:0; font-family: Poppins,sans-serif; background: var(--bg-gradient); color: #194357; min-height:100vh;}
    header { background: var(--secondary); box-shadow:0 2px 14px #0002; position:sticky;top:0;z-index:1000; }
    .navbar { display:flex;align-items:center;max-width:1200px;margin:auto;padding:0 20px;}
    .brand {font-weight:800;color:#f2f7fa;font-size:1.5rem;display:flex;align-items:center; letter-spacing:1px;}
    .logo { font-size:2.2rem; margin-right:9px; user-select:none; animation:wave 2.4s infinite; transform-origin: 70% 70%;}
    @keyframes wave {0%,100%{transform:rotate(0)} 25%{transform:rotate(12deg)} 50%{transform:rotate(-8deg)} 75%{transform:rotate(6deg)}}
    .navlinks {margin-left:auto;display:flex;gap:5px;}
    .navbtn {background:none;border:none;outline:none;font-weight:700;color:#f2f7fa;font-size:1.1rem;padding:12px 23px 11px 23px;border-radius:11px;cursor:pointer;transition:background .21s;}
    .navbtn.active,.navbtn:focus,.navbtn:hover {background:var(--accent);color:#173247;}
    main {max-width:1200px;margin:0 auto;min-height:89vh;padding:0 12px;}
    .sections {margin-top:16px;}
    section.tab {display:none;animation:fadein .5s;}
    section.tab.active {display:block;}
    @keyframes fadein {from{opacity:.0;transform:translateY(44px);} to{opacity:1;transform:translateY(0);}}
    /* ----------- HOMEPAGE ------------- */
    .hero-box {display:flex;align-items:center;gap:54px;margin-top:36px;justify-content:center;flex-wrap:wrap;}
    .hero-blurb {max-width:430px;}
    .hero-blurb h1 {
      font-size:2.7rem;font-weight:900;color:white;
      text-shadow:0 5px 28px #003f97cc;
      margin-bottom:13px;
    }
    .hero-blurb h1 .hl {
      color:#18bcce;
      text-shadow:0 6px 35px #5ff2fa,0 1px 1px #fff;
      filter:drop-shadow(0 0 14px #46fdffe7);
    }
    .hero-blurb p {font-size:1.13rem;color:#eaf9fa;font-weight:600; margin-bottom:30px;}
    .cta-btn {padding:17px 41px;font-size:1.15rem;font-weight:800;border-radius:15px;box-shadow:0 2px 18px #0002;background:linear-gradient(100deg,#28c7d5,#6fffdc,#04d98b 92%);color:#124031;border:none;margin-top:25px;outline:none;transition:transform .2s;}
    .cta-btn:hover{background-position:0 90%;transform:scale(1.08);}
    .hero-img {background:radial-gradient(ellipse at 60% 40%,#c6fbff 55%,#117bb3 100%);width:315px;height:168px;border-radius:2.2em;box-shadow:0 16px 44px #5be9fa22, 0 1.7px 19px #15527140;overflow:hidden;position:relative;}
    .animated-water-bg {width:295px;height:140px;margin:15px auto 0 auto;}
    .howto {margin:42px 0 37px 0;}
    .howto h2 {color:var(--primary);font-size:1.25rem;}
    .howto ol {padding-left:23px;}
    .howto a {color:var(--primary);font-weight:700;text-decoration:underline;}
    /* ----------- MEASURE+MAP ----------- */
    .flex-row {display:flex;gap:33px;margin:20px 0;align-items:stretch;flex-wrap:wrap;}
    .measure-card {background:var(--card);border-radius:1.3em;box-shadow:0 7px 30px #43cea41c;padding:31px 28px;max-width:420px;min-width:310px;}
    .measure-card label {font-weight:700;display:block;margin-top:22px;color:#114c3c;}
    .measure-card input[type=number],.measure-card select {width:100%;border-radius:11px;border:1.7px solid #92d4c3;padding:12px 12px;margin-top:6px;font-size:1.055rem;}
    .row {margin-top:22px;display:flex;gap:7px;}
    .measure-card button {font-weight:700;border:none;border-radius:13px;padding:11px 20px;background:var(--primary);color:#fff;margin-top:13px;box-shadow:0 4px 17px #31eaea22;transition:transform .15s;}
    .measure-card button:hover {background:var(--accent);color:#134227;transform:scale(1.06);}
    .measure-card .location-block{margin-top:13px;}
    .measure-card .result-card {background:#eafbe1;border-radius:1.12em;padding:19px 13px;display:flex;gap:16px;align-items:center;margin:15px 0 3px 0;animation:bubblein .42s;}
    @keyframes bubblein {from{opacity:0;transform:scale(0.7);} to{opacity:1;transform:scale(1);}}
    .bubble-idx {width:82px;height:82px;background:linear-gradient(120deg,var(--bubble),#4dfbcb 180%);border-radius:50%;color:#fff;font-size:2.6rem;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 8px 26px #139cfa4c, 0 2.1px 15px #65facb90;flex-shrink:0;animation:popbubble 0.8s cubic-bezier(.16,1.6,.49,1);}
    @keyframes popbubble {from{transform:scale(.3);opacity:.15;} to{transform:scale(1);opacity:1;}}
    .result-meta {flex:1;}
    .chip {display:inline-block;padding:6px 15px;border-radius:888px;font-weight:800;margin-left:9px;font-size:1.02rem;}
    .chip.good {background:var(--good);color:#fff;}
    .chip.warn {background:var(--warn);color:#222;}
    .chip.bad {background:var(--bad);}
    .result-meta .adv {margin-top:7px;font-size:1.06rem;color:#174357d2;background:rgba(67,206,162,.11);padding:7px 13px;border-radius:8px;}
    .smallnote {color:#347e83;font-size:0.93rem;margin-top:5px;}
    .history {margin-top:22px;background:var(--card);border-radius:1.2em;box-shadow:0 1.7px 12px #43cea41b;padding:7px 13px 13px;}
    .history h3 {margin:7px 0 0 0;font-weight:700;color:var(--primary);}
    .history table {width:100%;border-collapse:collapse;margin-top:6px;}
    .history th,.history td {padding:8px 7px;font-size:0.99rem; text-align:center;}
    .history th {background:#f8fbfa;border-bottom:2.5px solid #eee;}
    .history tr {animation:slideinhist .48s;}
    @keyframes slideinhist {from{opacity:.0;transform:translateY(33px);} to{opacity:1;transform:translateY(0);}}
    .history td {border-bottom:1px solid #f1f1f2;}
    /* ----------- MAP ----------- */
    #liveMap {width:390px;height:413px;border-radius:1.3em;box-shadow:0 12px 36px #0001;}
    @media (max-width: 1060px) {.flex-row{flex-direction: column;}#liveMap{width:95vw;margin-top:30px;}}
    @media (max-width: 650px) {main {padding:0;} .hero-box,.flex-row{flex-direction:column;} .hero-img,.animated-water-bg,#liveMap{width:100%;height:173px;min-width:0;}}
  </style>
</head>
<body>
<header>
  <div class="navbar">
    <span class="brand"><span class="logo">ðŸŒŠ</span> Water Health Index</span>
    <nav class="navlinks">
      <button class="navbtn active" data-tab="home">Home</button>
      <button class="navbtn" data-tab="measure">Measure</button>
      <button class="navbtn" data-tab="map">Map</button>
      <button class="navbtn" data-tab="phchart">pH Chart</button>
      <button class="navbtn" data-tab="care">Care</button>
      <button class="navbtn" data-tab="details">Details</button>
    </nav>
  </div>
</header>
<main>
  <div class="sections">
    <!-- Home tab -->
    <section class="tab active" data-tab="home">
      <div class="hero-box">
        <div class="hero-blurb">
          <h1>
            Welcome to <span class="hl">Water Health Index</span>
          </h1>
          <p>
            Discover, measure, and share water quality.<br>
            Fast, science-powered, and super easy â€” made for students and teams!
          </p>
          <button class="cta-btn" data-goto="measure">Start Measurement</button>
        </div>
        <div class="hero-img">
          <div class="animated-water-bg">
            <svg width="295" height="140" xmlns="http://www.w3.org/2000/svg">
              <defs>
                <linearGradient id="a" x1="0" x2="0" y1="0" y2="1">
                  <stop offset="0%" stop-color="#8ee8fc"/>
                  <stop offset="100%" stop-color="#49deff"/>
                </linearGradient>
                <filter id="blur" x="-10%" width="120%" y="-10%" height="140%">
                  <feGaussianBlur stdDeviation="9"/>
                </filter>
                <filter id="glow"><feGaussianBlur stdDeviation="4" result="coloredBlur"/>
                  <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <ellipse cx="148" cy="119" rx="135" ry="22" fill="#49deff" fill-opacity="0.55" filter="url(#blur)"/>
              <path id="wave"
                d="M0,90 Q37,85 65,110 Q120,145 150,110 Q175,85 240,110 Q270,125 295,100 L295,140 L0,140 Z"
                fill="url(#a)" filter="url(#glow)">
                <animate attributeName="d"
                        dur="5s"
                        repeatCount="indefinite"
                        values="
                          M0,90 Q37,85 65,110 Q120,145 150,110 Q175,85 240,110 Q270,125 295,100 L295,140 L0,140 Z;
                          M0,90 Q30,110 75,100 Q130,125 157,119 Q185,133 240,97 Q275,115 295,100 L295,140 L0,140 Z;
                          M0,90 Q37,85 65,110 Q120,145 150,110 Q175,85 240,110 Q270,125 295,100 L295,140 L0,140 Z
                        "/>
              </path>
            </svg>
          </div>
        </div>
      </div>
      <div class="howto">
        <h2>How It Works</h2>
        <ol>
          <li>Enter your sample data: pH, temperature, turbidity.</li>
          <li>Scan your pH strip with the camera for precision.</li>
          <li>Pin your reading on the world map and observe water health globally.</li>
        </ol>
        <p>Explore the <a href="#" class="tablink" data-goto="phchart">pH Chart</a> and <a href="#" class="tablink" data-goto="care">Care Tips</a>.</p>
      </div>
    </section>
    <!-- Measure tab -->
    <section class="tab" data-tab="measure">
      <div class="flex-row">
        <form class="measure-card" id="measureForm" autocomplete="off" onsubmit="return false">
          <label for="phInput">pH (0.0 - 14.0)</label>
          <input id="phInput" type="number" step="0.1" min="0" max="14" required placeholder="e.g., 7.2">
          <label for="tempInput">Temperature (Â°C)</label>
          <input id="tempInput" type="number" step="0.1" min="-5" max="60" required placeholder="e.g., 23.4">
          <label for="turbiditySelect">Turbidity</label>
          <select id="turbiditySelect" required>
            <option value="">Select turbidity</option>
            <option value="low">Low â€” Clear</option>
            <option value="medium">Medium â€” Cloudy</option>
            <option value="high">High â€” Muddy</option>
          </select>
          <div class="row">
            <button type="button" id="analyzeBtn">Analyze</button>
            <button type="button" id="cameraBtn">Camera</button>
            <button type="button" id="switchCamBtn">Switch Camera</button>
          </div>
          <div id="cameraArea" style="display:none;">
            <video id="video" autoplay playsinline style="width:100%;border-radius:10px;margin-top:10px;"></video>
            <div class="row">
              <button type="button" id="captureBtn">Capture Color</button>
              <button type="button" id="closeCamBtn">Close Camera</button>
            </div>
            <div class="smallnote" id="cameraNote">Align and hold your pH strip steady under good light!</div>
          </div>
          <div class="location-block">
            <button type="button" id="locBtn">Use My Location</button>
            <div class="smallnote" id="locLabel">No location attached</div>
          </div>
          <div id="resultBlock" class="result-card" style="display:none;">
            <div class="bubble-idx" id="idxBubble">--</div>
            <div class="result-meta">
              <span id="statusText">
                <b>Status: </b> <span class="chip">--</span>
              </span>
              <div id="subScores" class="smallnote"></div>
              <div class="adv" id="adviceText"></div>
            </div>
          </div>
          <div class="row">
            <button type="button" id="saveBtn">Save Reading</button>
            <button type="button" id="clearBtn" style="background:#d90d45;color:#fff;">Clear History</button>
          </div>
        </form>
        <div>
          <div id="liveMap"></div>
          <div class="map-legend">Your saved readings appear here.<br>Green=Good, Yellow=Moderate, Red=Poor</div>
        </div>
      </div>
      <div class="history" id="historyBlock" style="display:none;">
        <h3>Saved Readings</h3>
        <table><thead>
          <tr><th>When</th><th>pH</th><th>Temp</th><th>Turb</th><th>Index</th></tr>
        </thead><tbody id="historyRows"></tbody></table>
      </div>
    </section>
    <!-- Map tab -->
    <section class="tab" data-tab="map">
      <h2 style="color:var(--primary);">All Measurements (Interactive Map)</h2>
      <div style="margin:22px 0;"><div id="bigMap" style="width:99%;max-width:900px;height:400px;border-radius:17px;margin:auto;border:2px solid #b1e4e9;"></div></div>
    </section>
    <!-- PH Chart tab -->
    <section class="tab" data-tab="phchart">
      <h2 style="color:var(--primary);">pH Chart</h2>
      <p>This section will visualize standard pH color ranges and what they mean for water health.<br>
      <b style="display:inline-block;margin-top:12px;">Coming soon!</b>
      </p>
    </section>
    <!-- Care tab -->
    <section class="tab" data-tab="care">
      <h2 style="color:var(--primary);">Water Care Tips</h2>
      <ul>
        <li>Keep water sources free of litter and industrial waste.</li>
        <li>Avoid letting detergents or fertilizers reach natural water.</li>
        <li>Plant trees and shrubs along rivers to reduce erosion.</li>
        <li><b>More best-practices coming soon.</b></li>
      </ul>
    </section>
    <!-- Details tab -->
    <section class="tab" data-tab="details">
      <h2 style="color:var(--primary);">Project Details</h2>
      <p>Created for the National School Team Project.<br>
        Contributors: Your Names Here.<br>
        <b>Technologies used:</b> HTML, CSS, JavaScript, LeafletJS, OpenStreetMap, Browser Geolocation.<br>
        <b>Contact:</b> your_email@example.com
      </p>
    </section>
  </div>
</main>
<!-- Scripts LAST -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Navigation */
document.querySelectorAll('.navbtn').forEach(btn=>{
  btn.onclick=function(){
    document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    let tab=btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(sec=>{
      sec.classList.remove('active');
      if(sec.dataset.tab===tab) sec.classList.add('active');
    });
    window.scrollTo(0,0);
    setTimeout(()=>{if(tab=='map'&&window.bigMap){window.bigMap.invalidateSize()}},100);
  };
});
document.querySelectorAll('.tablink,.cta-btn').forEach(link=>{
  link.onclick=function(e){
    e.preventDefault();
    let tab=this.dataset.goto;
    document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.navbtn[data-tab="'+tab+'"]').classList.add('active');
    document.querySelectorAll('.tab').forEach(sec=>{
      sec.classList.remove('active');
      if(sec.dataset.tab===tab) sec.classList.add('active');
    });
    setTimeout(()=>{if(tab=='map'&&window.bigMap){window.bigMap.invalidateSize()}},100);
  }
});
/* Score utils */
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function scorePH(ph){const diff=Math.abs(ph-7.0);const penalty=7.5*Math.pow(diff,1.55);return clamp(100-penalty,0,100);}
function scoreTemp(t){if(isNaN(t))return 80;if(t>=20&&t<=26)return 100;if(t<20)return clamp(100-Math.pow(20-t,1.2)*4.5,0,100);return clamp(100-Math.pow(t-26,1.25)*5.5,0,100);}
function scoreTurb(t){if(t==='low')return 100;if(t==='medium')return 62;if(t==='high')return 28;return 50;}
function adviceFor(index){if(index>=95)return"Outstanding water quality!";if(index>=85)return"Excellent â€” minimal stress.";if(index>=75)return"Very Good condition.";if(index>=60)return"Monitor seasonally.";if(index>=45)return"Borderline: protect sources.";return "Poor water quality; test for pollution sources.";}
function statusChipClass(idx){if(idx>=80){return 'good'}else if(idx>=50){return 'warn'}else{return 'bad'}}

/* CAMERA + TOGGLE */
let usingBackCamera = true;
const vid=document.getElementById('video'),cameraArea=document.getElementById('cameraArea');
const cameraBtn=document.getElementById('cameraBtn'),captureBtn=document.getElementById('captureBtn'),closeCamBtn=document.getElementById('closeCamBtn'),switchCamBtn=document.getElementById('switchCamBtn');
let mediaStream=null;
cameraBtn.onclick=openCamera;
switchCamBtn.onclick = function () {
  usingBackCamera = !usingBackCamera;
  closeCamBtn.click();
  setTimeout(openCamera, 400);
};
function openCamera() {
  navigator.mediaDevices.getUserMedia({
    video: { facingMode: usingBackCamera ? { exact: "environment"} : "user" }
  }).then(s => {
    mediaStream = s;
    vid.srcObject = s;
    cameraArea.style.display='block';
  }).catch(()=>alert('Camera not available or allowed.'));
}
closeCamBtn.onclick=()=>{mediaStream&&mediaStream.getTracks().forEach(t=>t.stop());vid.srcObject=null;cameraArea.style.display='none';};
captureBtn.onclick=()=>{
if(!mediaStream)return;
let c=document.createElement('canvas'),w=vid.videoWidth,h=vid.videoHeight;
c.width=w;c.height=h;let ctx=c.getContext('2d');
ctx.drawImage(vid,0,0,w,h);
let d=ctx.getImageData(w/2-15,h/2-15,30,30).data,r=0,g=0,b=0,count=0;
for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];count++;}
r=Math.round(r/count);g=Math.round(g/count);b=Math.round(b/count);
function estimatePH(r,g,b){
  const mx=Math.max(r,g,b),mn=Math.min(r,g,b),diff=mx-mn;
  let hue=0;if(diff===0)hue=0;else if(mx===r)hue=(60*((g-b)/diff)+360)%360;
  else if(mx===g)hue=(60*((b-r)/diff)+120)%360;else hue=(60*((r-g)/diff)+240)%360;
  let ph=7;if(hue>=330||hue<=30)ph=3+(30-Math.abs(hue<=30?hue:360-hue))/30*2;
  else if(hue>30&&hue<=80)ph=5+(80-hue)/50*2;
  else if(hue>80&&hue<=160)ph=7+(160-hue)/80*1.2;
  else if(hue>160&&hue<=260)ph=8.5+(260-hue)/100*2.5;
  return clamp(Math.round(ph*100)/100,0,14);
}
let estPH=estimatePH(r,g,b);
document.getElementById('phInput').value=estPH;
document.getElementById('cameraNote').textContent=`Detected color: R${r} G${g} B${b} â†’ pH â‰ˆ ${estPH}`;
};

/* LOCATION */
let readingPlace='',readingCoords=null;
function reverseGeocode(lat,lng,cb){
fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`).then(r=>r.json())
.then(data=>cb(data.display_name||`${lat.toFixed(3)},${lng.toFixed(3)}`)).catch(()=>cb(`${lat.toFixed(3)},${lng.toFixed(3)}`));
}
const locBtn=document.getElementById('locBtn'),locLabel=document.getElementById('locLabel');
locBtn.onclick=()=>{
  locLabel.textContent='Getting location...';
  navigator.geolocation.getCurrentPosition(pos=>{
    readingCoords={lat:pos.coords.latitude,lng:pos.coords.longitude};
    reverseGeocode(pos.coords.latitude,pos.coords.longitude,function(name){
      readingPlace=name;locLabel.textContent=name;
    });
  },()=>{locLabel.textContent='Location denied/unavailable.';});
};

/* INDEX/FORM/SAVE */
const phInput=document.getElementById('phInput'),tempInput=document.getElementById('tempInput'),turbiditySelect=document.getElementById('turbiditySelect');
const analyzeBtn=document.getElementById('analyzeBtn'),resultBlock=document.getElementById('resultBlock');
const idxBubble=document.getElementById('idxBubble'),statusText=document.getElementById('statusText'),adviceText=document.getElementById('adviceText'),subScores=document.getElementById('subScores');
let savedReadings=[];
analyzeBtn.onclick=function(){
  let pH=parseFloat(phInput.value),temp=parseFloat(tempInput.value),turb=turbiditySelect.value;
  if(isNaN(pH)||isNaN(temp)||!turb){alert('Enter all values first.');return;}
  let idxRaw=scorePH(pH)*0.5+scoreTemp(temp)*0.25+scoreTurb(turb)*0.25;
  idxRaw=clamp(Math.round(idxRaw),0,100);
  let chipClass=statusChipClass(idxRaw),chipTxt=chipClass==='good'?'GOOD':(chipClass==='warn'?'MODERATE':'POOR');
  resultBlock.style.display='flex';
  idxBubble.textContent=idxRaw;
  idxBubble.style.background=idxRaw>=80?"linear-gradient(120deg,#17a232,#60faab 180%)":idxRaw>=50?"linear-gradient(120deg,#ffe93b,#e6cd5b 180%)":"linear-gradient(120deg,#bc1e32,#f97c7c 180%)";
  statusText.innerHTML=`<b>Status:</b> <span class="chip ${chipClass}">${chipTxt}</span>`;
  subScores.innerHTML=`pH: <b>${Math.round(scorePH(pH))}</b> &bull; Temp: <b>${Math.round(scoreTemp(temp))}</b> &bull; Turbidity: <b>${Math.round(scoreTurb(turb))}</b>`;
  adviceText.textContent=adviceFor(idxRaw);
  resultBlock.idxVal=idxRaw;
  setTimeout(()=>resultBlock.classList.add('pulse'),15); setTimeout(()=>resultBlock.classList.remove('pulse'),890);
};
/* HISTORY */
function showHistory() {
  const historyBlock=document.getElementById('historyBlock');
  const rows=document.getElementById('historyRows');
  if(!savedRead

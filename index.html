<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Water Health Index - Home & Measure</title>
<meta name="description" content="Water Health Index combined Home and Measurement page with interactive map, camera pH reader, and index calculation." />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  /* Basic Reset */
  *, *::before, *::after {
    box-sizing: border-box;
  }
  body {
    margin:0; padding:0; font-family: 'Poppins', Arial, sans-serif; background: linear-gradient(135deg, #0093E9, #80D0C7);
    color: #274142;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    min-height: 100vh;
  }
  a {
    text-decoration:none; color:inherit;
  }
  a:hover {
    color:#2e7d32;
    text-decoration:underline;
  }
  /* Container */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding:0 20px 40px 20px;
  }
  /* Header & Nav */
  header {
    position: sticky;
    top:0;
    background: rgba(2, 96, 133, 0.9);
    padding: 12px 0;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.18);
    user-select:none;
  }
  nav {
    max-width:1100px;
    margin:auto;
    display:flex;
    justify-content: space-between;
    align-items:center;
    padding: 0 20px;
  }
  nav .brand {
    font-weight: 700;
    font-size: 1.4rem;
    display:flex;
    align-items:center;
    gap:10px;
    color:#e4f1f7;
  }
  nav .brand .logo {
    font-size: 1.9rem;
    user-select:none;
    animation: wave 3s infinite ease-in-out;
    transform-origin: 70% 70%;
  }
  @keyframes wave {
    0%, 60%, 100% { transform: rotate(0deg); }
    30% { transform: rotate(15deg); }
    45% { transform: rotate(-10deg); }
  }
  nav ul {
    list-style:none;
    display:flex;
    gap:16px;
    margin:0; padding:0;
  }
  nav ul li {
    font-weight: 600;
  }
  nav ul li a {
    color: #e4f1f7;
    padding: 8px 14px;
    border-radius: 10px;
    transition: background-color 0.3s ease;
  }
  nav ul li a.active, nav ul li a:hover {
    background-color: #66bb6a;
    color:#fff;
    box-shadow: 0 6px 18px rgba(102, 187, 106, 0.5);
  }
  /* Page sections */
  main {
    padding-top: 40px;
    min-height: calc(100vh - 80px);
  }
  /* Tabs wrapper */
  #pageTabs {
    display: flex;
    justify-content: center;
    gap: 28px;
    margin-bottom: 28px;
  }
  #pageTabs button {
    background: transparent;
    border: none;
    font-weight: 700;
    font-size: 1.15rem;
    color: #274142;
    padding: 10px 24px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 3px 6px rgba(0,0,0,0.07);
    transition: background-color 0.35s ease;
    user-select:none;
  }
  #pageTabs button.active, #pageTabs button:hover {
    background-color: #2e7d32;
    color: white;
    box-shadow: 0 8px 28px rgba(46, 125, 50, 0.4);
  }
  /* Section visibility toggle */
  section.page-section {
    display: none;
  }
  section.page-section.active {
    display: block;
  }
  /* --- HOME SECTION --- */
  #homeSection .hero {
    display: flex;
    gap: 48px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    margin-bottom: 36px;
  }
  #homeSection .hero-text {
    max-width: 600px;
    color: #e4f1f7;
    text-shadow: 0 0 6px rgba(0,0,0,0.2);
  }
  #homeSection .hero-text h1 {
    font-size: 3rem;
    margin-bottom: 12px;
  }
  #homeSection .highlight {
    color: #2e7d32;
    text-shadow: 0 2px 8px #1b4414;
  }
  #homeSection .hero-text p {
    font-weight: 600;
    font-size: 1.2rem;
    max-width: 520px;
  }
  #homeSection .hero-text a.btn-large {
    background: linear-gradient(135deg, #2e7d32, #66bb6a);
    color: #fff;
    padding: 14px 36px;
    font-weight: 700;
    border-radius: 20px;
    box-shadow: 0 12px 28px rgba(102, 187, 106, 0.6);
    text-align: center;
    display: inline-block;
    margin-top: 28px;
    user-select:none;
    transition: box-shadow 0.3s ease;
  }
  #homeSection .hero-text a.btn-large:hover {
    box-shadow: 0 16px 34px rgba(102, 187, 106, 0.8);
  }
  #homeSection .hero-map {
    flex-shrink: 0;
    width: 460px;
    height: 320px;
    border-radius: 16px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.15);
    border: 3px solid rgba(255 255 255 / 0.35);
  }
  #homeSection .howto {
    max-width: 650px;
    margin: 0 auto 48px;
    color: #d9f2d9;
    font-weight: 600;
    font-size: 1.15rem;
    line-height: 1.5;
  }
  #homeSection .howto ol {
    padding-left: 20px;
    margin: 20px 0 12px 0;
  }
  #homeSection .howto ol > li {
    margin-bottom: 18px;
  }
  #homeSection .howto a {
    font-weight: 700;
    color: #c8f2bd;
    border-bottom: 1px solid #c8f2bd;
  }
  #homeSection .howto a:hover {
    color: #e3ffca;
    border-color: #e3ffca;
  }
  #homeSection .recent-list {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    justify-content: center;
  }
  #homeSection .recent-card {
    background: rgba(255 255 255 / 0.9);
    border-radius: 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.22);
    width: 280px;
    padding: 20px 18px;
    color: #274142;
    user-select:none;
    transition: box-shadow 0.25s ease;
  }
  #homeSection .recent-card:hover {
    box-shadow: 0 16px 38px rgba(0,0,0,0.33);
    cursor: pointer;
  }
  #homeSection .recent-card b {
    font-size: 1.25rem;
    margin-bottom: 6px;
    display: block;
  }
  #homeSection .tag {
    background: #2e7d32;
    color: white;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: 13px;
    font-size: 1rem;
    display: inline-block;
    min-width: 44px;
    text-align: center;
  }
  #homeSection .date {
    font-weight: 600;
    font-size: 0.92rem;
    color: #446643;
    margin-top: 8px;
    opacity: 0.85;
  }
  #homeSection .loader {
    font-weight: 700;
    font-size: 1.3rem;
    color: #cbe3f1;
    margin: 70px 0;
    text-align: center;
    user-select:none;
  }
  /* --- MEASURE SECTION --- */
  #measureSection {
    max-width: 1000px;
    margin: 0 auto 80px;
    color: #274142;
  }
  #measureSection h2 {
    color: #276636;
    font-weight: 800;
    font-size: 2.5rem;
    margin-bottom: 20px;
  }
  #measureSection p.subtext {
    font-weight: 500;
    color: #274142dd;
    margin-bottom: 24px;
  }
  /* The form container (left side) and sidebar (right side) */
  #measureSection .layout {
    display: flex;
    gap: 32px;
    flex-wrap: wrap;
  }
  #measureSection .form-container {
    flex: 1 1 450px;
    background: rgba(255,255,255,0.9);
    padding: 24px 32px;
    border-radius: 18px;
    box-shadow: 0 18px 52px rgba(2,60,80,0.12);
  }
  #measureSection label {
    display: block;
    font-weight: 700;
    margin-top: 18px;
    color: #274142ee;
  }
  #measureSection input[type=number],
  #measureSection select {
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid #b2d0cc;
    margin-top: 6px;
    font-size: 1.1rem;
    font-weight: 500;
    outline-offset: 2px;
    outline-color: transparent;
    transition: outline-color 0.35s ease;
  }
  #measureSection input[type=number]:focus,
  #measureSection select:focus {
    outline-color: #2e7d32cc;
  }
  #measureSection .controls-row {
    margin-top: 26px;
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
  }
  #measureSection .btn {
    cursor: pointer;
    border:none;
    border-radius: 14px;
    font-weight: 700;
    padding: 14px 28px;
    font-size: 1.1rem;
    user-select:none;
    box-shadow: 0 10px 32px rgba(0,0,0,0.13);
    transition: background 0.3s ease;
  }
  #measureSection .btn-primary {
    background: linear-gradient(135deg, #2e7d32, #66bb6a);
    color: white;
  }
  #measureSection .btn-primary:hover {
    background: linear-gradient(135deg, #1b4414, #55a151);
  }
  #measureSection .btn-ghost {
    background: transparent;
    border: 2px solid #2e7d32cc;
    color: #2e7d32cc;
  }
  #measureSection .btn-ghost:hover {
    color: #2e7d32;
    border-color: #2e7d32;
  }
  /* Camera UI */
  #measureSection #cameraArea {
    margin-top: 28px;
    padding: 16px;
    border: 2px dashed #2e7d32cc;
    border-radius: 14px;
    position: relative;
    background: #eef9f4;
  }
  #measureSection video#videoPreview {
    width: 100%;
    border-radius: 14px;
  }
  #measureSection .camera-overlay {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 80px; height: 80px;
    border-radius: 12px;
    border: 3px dashed #2e7d32cc;
    pointer-events: none;
  }
  /* Result card */
  #measureSection #resultCard {
    margin-top: 22px;
    background: #e8f7ed;
    color: #2e7d32;
    padding: 26px 24px;
    border-radius: 18px;
    box-shadow: 0 8px 26px rgba(46,125,50,0.2);
    font-weight: 700;
    font-size: 1.55rem;
    user-select:none;
  }
  #measureSection #resultCard .index-score {
    font-size: 2.8rem;
    font-weight: 900;
    color: #2e7d32;
    text-shadow: 0 0 10px #66bb6aaa;
    margin-bottom: 8px;
  }
  #measureSection .small-note {
    font-size: 0.9rem;
    font-weight: 600;
    color: #457451cc;
    margin-top: 6px;
  }
  #measureSection .status-chip {
    margin-left: 12px;
    padding: 5px 14px;
    border-radius: 24px;
    font-weight: 900;
    color:white;
    font-size: 0.95rem;
    vertical-align: middle;
    user-select:none;
  }
  #measureSection .status-good {
    background: #2e7d32;
  }
  #measureSection .status-warn {
    background: #f9a825;
    color: #352a11;
  }
  #measureSection .status-bad {
    background: #c62828;
  }
  /* Sidebar with tips */
  #measureSection aside {
    flex: 0 0 320px;
    background: rgba(255 255 255 / 0.9);
    border-radius: 18px;
    padding: 24px 20px;
    box-shadow: 0 16px 46px rgba(0,0,0,0.1);
  }
  #measureSection aside h3 {
    font-weight: 800;
    color: #2e7d32;
    margin-bottom: 20px;
    text-align: center;
  }
  #measureSection aside p {
    font-size: 1rem;
    font-weight: 600;
    color: #274142cc;
    line-height: 1.52;
  }
  #measureSection aside ul {
    margin-top: 18px;
    list-style-type: disc;
    padding-left: 20px;
  }
  #measureSection aside ul li {
    margin-bottom: 12px;
  }
  /* Responsive */
  @media (max-width: 960px) {
    nav ul {
      gap: 10px;
    }
    #homeSection .hero,
    #homeSection .hero-map {
      width: 100% !important;
      height: 250px !important;
    }
    #homeSection .hero-text {
      max-width: 100%;
      text-align: center;
    }
    #measureSection .layout {
      flex-direction: column;
    }
    #measureSection aside {
      width: 100%;
      margin-top: 36px;
    }
  }
  @media (max-width: 480px) {
    nav ul li a {
      font-size: 0.9rem;
      padding: 6px 8px;
    }
    .btn-large {
      padding: 12px 28px;
      font-size: 1rem;
    }
  }
</style>
</head>
<body>
<header>
  <nav>
    <div class="brand" aria-label="Water Health Index Logo and title">
      <span class="logo" aria-hidden="true">ðŸŒŠ</span> Water Health Index
    </div>
    <ul role="menubar" aria-label="Primary Navigation">
      <li role="none"><button id="tabHome" role="tab" aria-selected="true" aria-controls="homeSection">Home</button></li>
      <li role="none"><button id="tabMeasure" role="tab" aria-selected="false" aria-controls="measureSection">Measure</button></li>
    </ul>
  </nav>
</header>
<main class="container">
  <!-- HOME SECTION -->
  <section id="homeSection" class="page-section active" role="tabpanel" tabindex="0" aria-labelledby="tabHome">
    <div class="hero">
      <div class="hero-text">
        <h1>Welcome to <span class="highlight">Water Health Index</span></h1>
        <p>Discover, measure, and share water quality <br /><strong>Fast, science-powered, and super easy â€” made for students and teams!</strong></p>
        <a href="#" id="startMeasurementBtn" class="btn-large" role="button" aria-label="Start Measurement Section">Start Measurement</a>
      </div>
      <div class="hero-map" id="homeMapPreview" aria-label="World Map preview showing recent water quality data"></div>
    </div>
    <div class="howto" tabindex="0" aria-label="How to use Water Health Index instructions">
      <h2>How It Works</h2>
      <ol>
        <li>Enter your sample data: pH, temperature, and turbidity.</li>
        <li>Scan your pH strip with the camera for precision measurements.</li>
        <li>Pin your reading on the world map and observe water health globally.</li>
      </ol>
      <p>Explore the <a href="phchart.html">pH Chart</a> and <a href="phcare.html">Care Tips</a> to learn more.</p>
    </div>
    <h2>Recent Shared Water Health Data</h2>
    <div id="recentReadings" class="recent-list" role="list" aria-live="polite" aria-atomic="true">
      <span class="loader" role="status" aria-live="polite">Loading data...</span>
    </div>
  </section>

  <!-- MEASURE SECTION -->
  <section id="measureSection" class="page-section" role="tabpanel" tabindex="0" aria-labelledby="tabMeasure" aria-hidden="true">
    <h2>Enter Your Water Measurements</h2>
    <p class="subtext">Type values or use the camera to scan a pH strip. Add your location and save to share.</p>
    <div class="layout">
      <form class="form-container" id="waterForm" novalidate>
        <label for="phInput">pH (0.0 - 14.0)</label>
        <input id="phInput" name="phInput" type="number" step="0.1" min="0" max="14" placeholder="e.g., 7.2" aria-describedby="phHelp" required />
        <div id="phHelp" class="small-note">Value range: 0.0 to 14.0</div>

        <label for="tempInput">Temperature (Â°C)</label>
        <input id="tempInput" name="tempInput" type="number" step="0.1" min="-5" max="60" placeholder="e.g., 24.5" aria-describedby="tempHelp" required />
        <div id="tempHelp" class="small-note">Typical range: -5 to 60 Â°C</div>

        <label for="turbiditySelect">Turbidity</label>
        <select id="turbiditySelect" name="turbiditySelect" required aria-describedby="turbHelp">
          <option value="">Select turbidity</option>
          <option value="low">Low â€” Clear</option>
          <option value="medium">Medium â€” Cloudy</option>
          <option value="high">High â€” Muddy</option>
        </select>
        <div id="turbHelp" class="small-note">Select the clarity level of water</div>

        <div class="controls-row">
          <button type="button" id="analyzeBtn" class="btn btn-primary">Calculate Index</button>
          <button type="button" id="cameraToggleBtn" class="btn btn-ghost" aria-pressed="false">Open Camera</button>
        </div>
        <!-- Camera Section -->
        <div id="cameraArea" style="display:none; margin-top:20px;">
          <video autoplay playsinline id="videoPreview" style="border-radius:12px; width:100%; background:#000;"></video>
          <div class="camera-overlay" aria-hidden="true"></div>
          <div style="margin-top:12px;" class="controls-row">
            <button type="button" id="captureBtn" class="btn btn-primary" aria-label="Capture Color from camera">Capture Color</button>
            <button type="button" id="closeCamBtn" class="btn btn-ghost" aria-label="Close Camera">Close Camera</button>
          </div>
          <div id="cameraNote" class="small-note" style="margin-top:8px;">Tip: Hold the pH strip steady inside the box under natural light.</div>
        </div>

        <div id="resultCard" style="display:none; margin-top: 32px;">
          <div class="index-score" aria-live="polite" aria-atomic="true">--</div>
          <div>
            <span id="statusChip" class="status-chip">---</span>
            <span id="subscores" style="margin-left:10px; font-weight:600;"></span>
          </div>
          <p id="advice" style="margin-top:12px; font-weight: 600;"></p>
        </div>

        <div style="margin-top:32px;" class="controls-row">
          <button type="button" id="useLocationBtn" class="btn btn-ghost">Use My Location</button>
          <span id="locStatus" class="small-note" style="margin-left:12px;">No location attached</span>
        </div>

        <div style="margin-top:20px;" class="controls-row">
          <button type="button" id="saveBtn" class="btn btn-primary">Save Reading</button>
          <button type="button" id="exportBtn" class="btn btn-ghost">Export Readings CSV</button>
        </div>
      </form>

      <aside>
        <h3>About Camera pH Reader</h3>
        <p>This uses color sampling of the strip center and compares to a calibration for better accuracy. Calibration improves pH readings under your camera and lighting conditions.</p>
      </aside>
    </div>
  </section>
</main>

<footer style="text-align:center; padding:20px 0; font-weight:600; background: #205836cc; color:#c8f2bd; user-select:none;">
  &copy; 2025 Water Health Index &mdash; School Project for National Team &mdash; <a href="details.html" style="color:#c8f2bd; font-weight:700; border-bottom:1px solid #c8f2bd;">Team & Info</a>
</footer>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // Page Tabs Handling
  const tabHome = document.getElementById('tabHome');
  const tabMeasure = document.getElementById('tabMeasure');
  const homeSection = document.getElementById('homeSection');
  const measureSection = document.getElementById('measureSection');
  const startMeasurementBtn = document.getElementById('startMeasurementBtn');

  function activateTab(tabButton, tabContentVisible) {
    // Clear all tabs first
    tabHome.setAttribute('aria-selected', 'false');
    tabMeasure.setAttribute('aria-selected', 'false');
    tabHome.classList.remove('active');
    tabMeasure.classList.remove('active');
    homeSection.classList.remove('active');
    measureSection.classList.remove('active');
    homeSection.setAttribute('aria-hidden', 'true');
    measureSection.setAttribute('aria-hidden', 'true');
    // Enable selected
    tabButton.setAttribute('aria-selected', 'true');
    tabButton.classList.add('active');
    tabContentVisible.classList.add('active');
    tabContentVisible.setAttribute('aria-hidden', 'false');
    tabContentVisible.focus();
  }
  tabHome.addEventListener('click', ()=> activateTab(tabHome, homeSection));
  tabMeasure.addEventListener('click', ()=> activateTab(tabMeasure, measureSection));
  startMeasurementBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    activateTab(tabMeasure, measureSection);
  });

  // Leaflet Map Initialization for Home section
  let map = null;
  const homeMapDiv = document.getElementById('homeMapPreview');
  if(homeMapDiv) {
    map = L.map('homeMapPreview', {
      center: [20,0],
      zoom: 2,
      zoomControl: false,
      attributionControl: false,
      dragging: false,
      tap: false,
      scrollWheelZoom: false,
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    // Sample water data sites
    const sampleSites = [
      {lat:28.61,lng:77.22,pH:7.2,idx:91,place:'Yamuna River, India'},
      {lat:40.71,lng:-74.0,pH:6.5,idx:80,place:'Hudson River, USA'},
      {lat:-33.87,lng:151.21,pH:8.1,idx:90,place:'Sydney Harbour, Australia'}
    ];

    function colorByIndex(idx) {
      if(idx>=80) return '#2e7d32';
      if(idx>=50) return '#f9a825';
      return '#c62828';
    }

    sampleSites.forEach(site => {
      let circle = L.circleMarker([site.lat, site.lng], {
        radius: 8,
        color: '#000',
        weight: 1.5,
        fillColor: colorByIndex(site.idx),
        fillOpacity: 0.85,
      }).addTo(map);

      circle.bindPopup(`<strong>${site.place}</strong><br/>pH: ${site.pH} <br/>Index: ${site.idx}`);
    });
  }

  // Recent Readings render
  const recentReadingsDiv = document.getElementById('recentReadings');
  const recentData = [
    {region:'Yamuna River, India', idx:91, ph:7.2, temp:24, date:'2025-11-12'},
    {region:'Hudson River, USA', idx:80, ph:6.5, temp:26, date:'2025-11-11'},
    {region:'Sydney Harbour, Australia', idx:90, ph:8.1, temp:22, date:'2025-11-10'}
  ];
  function renderRecentReadings(){
    if(!recentReadingsDiv) return;
    recentReadingsDiv.innerHTML = '';
    recentData.forEach(r => {
      let color = r.idx >= 80 ? '#2e7d32' : r.idx >= 50 ? '#f9a825' : '#c62828';
      let card = document.createElement('div');
      card.className = 'recent-card';
      card.tabIndex = 0;
      card.innerHTML = `
        <b>${r.region}</b>
        <div>Index: <span class="tag" style="background-color:${color}">${r.idx}</span></div>
        <div>pH: <span class="tag">${r.ph.toFixed(1)}</span> | Temp: <span class="tag">${r.temp}Â°C</span></div>
        <div class="date">${new Date(r.date).toLocaleDateString()}</div>
      `;
      recentReadingsDiv.appendChild(card);
    });
  }
  renderRecentReadings();

  // Measurement Section Logic
  const phInput = document.getElementById('phInput');
  const tempInput = document.getElementById('tempInput');
  const turbiditySelect = document.getElementById('turbiditySelect');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const resultCard = document.getElementById('resultCard');
  const indexScoreEl = resultCard.querySelector('.index-score');
  const statusChip = document.getElementById('statusChip');
  const subscoresEl = document.getElementById('subscores');
  const adviceEl = document.getElementById('advice');
  const useLocationBtn = document.getElementById('useLocationBtn');
  const locStatus = document.getElementById('locStatus');
  const saveBtn = document.getElementById('saveBtn');
  const exportBtn = document.getElementById('exportBtn');
  
  let currentLocation = null;
  let savedReadings = [];

  // Utility functions for scoring
  function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
  function round(v,d=0){return Number(v.toFixed(d));}
  function scorePH(ph) {
    const diff = Math.abs(ph - 7.0);
    const penalty = 7.5 * Math.pow(diff, 1.55);
    return clamp(100 - penalty, 0, 100);
  }
  function scoreTemp(t) {
    if(isNaN(t)) return 80;
    if(t >= 20 && t <= 26) return 100;
    if(t < 20) return clamp(100 - Math.pow(20 - t, 1.2) * 4.5, 0, 100);
    return clamp(100 - Math.pow(t - 26, 1.25) * 5.5, 0, 100);
  }
  function scoreTurb(t) {
    if(t === 'low') return 100;
    if(t === 'medium') return 62;
    if(t === 'high') return 28;
    return 50;
  }

  const ADVICE_BANK = [
    "100 â€” Pristine water. Preserve this site.",
    "95â€“99 â€” Outstanding water quality. Monitor regularly.",
    "90â€“94 â€” Near-perfect, suitable for recreation.",
    "85â€“89 â€” Excellent water quality.",
    "80â€“84 â€” Very good, minor cautions.",
    "75â€“79 â€” Good, slight stress to aquatic life.",
    "70â€“74 â€” Fair-good condition.",
    "65â€“69 â€” Fair, consider filtration.",
    "60â€“64 â€” Moderate condition.",
    "55â€“59 â€” Borderline, protective measures advised.",
    "50â€“54 â€” Use filtration or avoid drinking untreated.",
    "45â€“49 â€” Below desirable, investigate causes.",
    "40â€“44 â€” Degraded, pollution likely.",
    "35â€“39 â€” Poor, reduce contamination inputs.",
    "30â€“34 â€” Very poor, further testing required.",
    "25â€“29 â€” Critical, avoid contact.",
    "20â€“24 â€” Severe pollution, urgent action.",
    "15â€“19 â€” Extreme ecosystem stress.",
    "10â€“14 â€” Near collapse, professional intervention.",
    "5â€“9 â€” Catastrophic, dangerous for wildlife.",
    "1â€“4 â€” Catastrophic II, do not approach.",
    "0 â€” Dead zone, long-term remediation needed."
  ];
  function adviceFor(index) {
    for(let i=0; i<ADVICE_BANK.length; i++){
      if(index >= 100 - i*5) return ADVICE_BANK[i];
    }
    return ADVICE_BANK[ADVICE_BANK.length-1];
  }
  
  function computeIndex(ph, temp, turb){
    const p = scorePH(ph);
    const t = scoreTemp(temp);
    const u = scoreTurb(turb);
    let raw = p * 0.5 + t * 0.25 + u * 0.25;
    const minSub = Math.min(p, t, u);
    if(minSub < 35) raw -= (35 - minSub) * 0.65;
    raw = clamp(Math.round(raw), 0, 100);
    return {index: raw, subs: {p, t, u}};
  }

  function analyzeNow(showUI = true) {
    const ph = parseFloat(phInput.value);
    const temp = parseFloat(tempInput.value);
    const turb = turbiditySelect.value;
    if(isNaN(ph) || isNaN(temp) || !turb){
      alert('Please provide valid pH, temperature, and turbidity.');
      return null;
    }
    const {index, subs} = computeIndex(ph, temp, turb);
    if(showUI){
      resultCard.style.display = 'block';
      indexScoreEl.textContent = index;
      if(index >= 80){
        statusChip.textContent = 'GOOD';
        statusChip.className = 'status-chip status-good';
      } else if(index >= 50){
        statusChip.textContent = 'MODERATE';
        statusChip.className = 'status-chip status-warn';
      } else {
        statusChip.textContent = 'POOR';
        statusChip.className = 'status-chip status-bad';
      }
      subscoresEl.textContent = `pH: ${Math.round(subs.p)} â€¢ Temp: ${Math.round(subs.t)} â€¢ Turb: ${Math.round(subs.u)}`;
      adviceEl.textContent = adviceFor(index);
    }
    return {ph,temp,turb,index,subs,loc: currentLocation};
  }

  analyzeBtn.addEventListener('click', ()=> analyzeNow(true));

  // Location acquisition
  useLocationBtn.addEventListener('click', () => {
    locStatus.textContent = 'Requesting location...';
    if(!navigator.geolocation) {
      locStatus.textContent = 'Geolocation not supported.';
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      currentLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
      };
      locStatus.textContent = `Location attached: ${currentLocation.lat.toFixed(3)}, ${currentLocation.lng.toFixed(3)}`;
    }, err => {
      locStatus.textContent = 'Location access denied or unavailable.';
      alert('Unable to fetch location. Please allow location access and try again.');
    }, {enableHighAccuracy:true, timeout: 10000});
  });

  // Local Storage to persist readings
  function loadReadings() {
    const stored = localStorage.getItem('wh_readings');
    if(!stored) return [];
    try {
      return JSON.parse(stored);
    } catch {
      return [];
    }
  }
  function saveReadings(readings) {
    localStorage.setItem('wh_readings', JSON.stringify(readings));
  }

  // Save reading button handler
  saveBtn.addEventListener('click', () =>{
    const reading = analyzeNow(false);
    if(!reading){
      alert('Please enter valid data and analyze before saving.');
      return;
    }
    reading.ts = Date.now();
    savedReadings.unshift(reading);
    saveReadings(savedReadings);
    alert('Reading saved locally.');
  });

  // Export CSV button
  exportBtn.addEventListener('click', () =>{
    if(savedReadings.length === 0){
      alert('No readings saved to export.');
      return;
    }
    const csvHeader = 'Timestamp,pH,Temperature,Turbidity,Index,Latitude,Longitude\n';
    const csvRows = savedReadings.map(r=>{
      const date = new Date(r.ts).toISOString();
      const lat = r.loc ? r.loc.lat : '';
      const lng = r.loc ? r.loc.lng : '';
      return `${date},${r.ph},${r.temp},${r.turb},${r.index},${lat},${lng}`;
    }).join('\n');
    const csvContent = csvHeader + csvRows;
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'water_health_readings.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
  });

  // Camera and pH strip color sampling (simplified)
  const video = document.getElementById('videoPreview');
  const cameraToggleBtn = document.getElementById('cameraToggleBtn');
  const cameraArea = document.getElementById('cameraArea');
  const captureBtn = document.getElementById('captureBtn');
  const closeCamBtn = document.getElementById('closeCamBtn');

  let mediaStream = null;

  async function openCamera() {
    try {
      mediaStream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}, audio: false});
      video.srcObject = mediaStream;
      cameraArea.style.display = 'block';
      cameraToggleBtn.setAttribute('aria-pressed', 'true');
    } catch(e) {
      alert('Camera access denied or unavailable.');
      console.warn(e);
    }
  }

  function closeCamera() {
    if(mediaStream){
      mediaStream.getTracks().forEach(track => track.stop());
      mediaStream = null;
    }
    video.srcObject = null;
    cameraArea.style.display = 'none';
    cameraToggleBtn.setAttribute('aria-pressed', 'false');
  }

  cameraToggleBtn.addEventListener('click', () => {
    if(mediaStream){
      closeCamera();
    } else {
      openCamera();
    }
  });
  closeCamBtn.addEventListener('click', closeCamera);

  // Capture color and estimate pH
  captureBtn.addEventListener('click', () => {
    if(!mediaStream){
      alert('Camera not open.');
      return;
    }
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    // Sample center pixel block 30x30 area
    const centerX = Math.floor(canvas.width / 2);
    const centerY = Math.floor(canvas.height / 2);
    const pixelData = ctx.getImageData(centerX - 15, centerY - 15, 30, 30).data;
    let r=0,g=0,b=0,count=0;
    for(let i=0; i<pixelData.length; i+=4){
      r += pixelData[i];
      g += pixelData[i+1];
      b += pixelData[i+2];
      count++;
    }
    r = Math.round(r / count);
    g = Math.round(g / count);
    b = Math.round(b / count);

    // Estimate the pH from RGB color (simplified heuristic)
    function rgbToPH(r,g,b){
      // Convert RGB to approximate pH scale by hue
      const mx = Math.max(r,g,b), mn = Math.min(r,g,b);
      const diff = mx - mn;
      let hue = 0;
      if(diff === 0) hue = 0;
      else if(mx === r) hue = ((60 * ((g - b) / diff) + 360) % 360);
      else if(mx === g) hue = ((60 * ((b - r) / diff) + 120) % 360);
      else hue = ((60 * ((r - g) / diff) + 240) % 360);
      let ph = 7.0;
      if(hue >= 330 || hue <= 30) ph = 3 + (30 - Math.abs(hue <= 30 ? hue : 360 - hue)) / 30 * 2;
      else if(hue > 30 && hue <= 80) ph = 5 + (80 - hue) / 50 * 2;
      else if(hue > 80 && hue <= 160) ph = 7 + (160 - hue) / 80 * 1.2;
      else if(hue > 160 && hue <= 260) ph = 8.5 + (260 - hue) / 100 * 2.5;
      if(((mx + mn) / 2 / 255) < 0.25) ph += (0.25 - ((mx + mn) / 2 / 255)) * 4;
      return clamp(round(ph,2), 0, 14);
    }
    const estimatedPH = rgbToPH(r,g,b);
    phInput.value = estimatedPH;
    const cameraNote = document.getElementById('cameraNote');
    cameraNote.textContent = `Captured color - R:${r} G:${g} B:${b} â†’ Estimated pH: ${estimatedPH}`;
  });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Health Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@700;600;400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body { background: linear-gradient(135deg, #43cea2 0, #185a9d 100%); font-family: Poppins,sans-serif; margin:0; color:#174256;}
    header { background: #156581; box-shadow: 0 2px 12px #0002; position:sticky;top:0;z-index:1000;}
    .navbar { display:flex;align-items:center;max-width:1200px;margin:auto;padding:0 16px;}
    .brand {font-weight:800;color:#f2f7fa;font-size:1.4rem;display:flex;align-items:center;}
    .logo { font-size:2rem; margin-right:9px; user-select:none; animation:wave 2.2s infinite;transform-origin: 70% 70%;}
    @keyframes wave {0%,100%{transform:rotate(0)} 25%{transform:rotate(12deg)} 50%{transform:rotate(-8deg)} 75%{transform:rotate(6deg)}}
    .navlinks {margin-left:auto;display:flex;gap:8px;}
    .navbtn {background:none;border:none;outline:none;font-weight:700;color:#f2f7fa;font-size:1.1rem;padding:9px 20px;border-radius:9px;cursor:pointer;transition:background .2s;}
    .navbtn.active,.navbtn:focus,.navbtn:hover {background:#54b489;color:#fff;}
    main {max-width:1280px;margin:0 auto;min-height:80vh;padding:0 12px;}
    .sections {margin-top:32px;}
    section.tab {display:none;animation: fadein 0.6s;}
    section.tab.active {display:block;}
    @keyframes fadein {from{opacity:0;transform:translateY(44px);} to{opacity:1;transform:translateY(0);}}
    /* Home */
    .home-flex {display:flex;align-items:center;gap:60px;flex-wrap:wrap;margin:20px 0 0 0;}
    .welcome {max-width:450px;}
    .welcome h1 {font-weight:800;font-size:2.5rem;margin-bottom:7px;color:#fff;text-shadow:0 5px 14px #0002;}
    .welcome h1 .hl {color:#43cea2;}
    .welcome p {color:#e6f1fa;font-weight:600;line-height:1.4;}
    .measure-btn {margin:28px 0 0 0;font-size:1.1rem;font-weight:800;border-radius:14px;background:linear-gradient(95deg,#439669,#76e6d8);color:#134227;padding:16px 36px;border:none;box-shadow:0 5px 23px #0002;}
    .measure-btn:hover {background:linear-gradient(90deg,#235450,#61d089);}
    .mapbox-home {width:410px;height:255px;border-radius:19px;background:#eaf7fa;box-shadow:0 9px 26px #0002;border:2px solid #b1e4e9;}
    .howto {margin:38px 0 24px 0;max-width:880px;}
    .howto h2 {color:#43cea2;font-size:1.45rem;}
    .howto ol {padding-left:26px;}
    .howto a {color: #43cea2; font-weight:700;}
    /* MEASURE/MAP FLEX */
    .flex-row {display:flex;gap:38px;margin:35px 0;align-items:stretch;flex-wrap:wrap;}
    .measure-card {background:#fff;border-radius:17px;box-shadow:0 7px 30px #43cea41c;padding:32px 30px;max-width:410px;min-width:314px;}
    .measure-card label {font-weight:700;display:block;margin-top:20px;color:#214836;}
    .measure-card input[type=number],.measure-card select {width:100%;border-radius:11px;border:1.5px solid #92d4c3;padding:11px 12px;margin-top:7px;font-size:1.06rem;}
    .measure-card .row {margin-top:22px;display:flex;gap:7px;}
    .measure-card button {font-weight:700; border:none; border-radius:12px; padding:11px 19px; background:#43cea2; color:#185a9d; margin-top:20px;cursor:pointer;}
    .measure-card button:hover {background:#2c937a;color:#fff;}
    .measure-card .note {color:#22835f;font-size:0.97rem;margin-top:5px;}
    .measure-card .location-block {margin-top:12px;}
    .measure-card .result {background:#eafbe1;border-radius:13px;padding:13px;margin:18px 0 0 0;}
    /* MAP */
    #liveMap {width:390px;height:400px;border-radius:18px;box-shadow:0 12px 38px #0002;border:2px solid #b1e4e9;}
    .map-legend {margin:7px 0 0 0;font-size:0.93rem;}
    /* Recent List Home */
    .recent-section {margin-top:48px;}
    .recent-list {display:flex;flex-wrap:wrap;gap:19px;margin-top:15px;}
    .recent-card {background:#fffdfc;border-radius:10px;box-shadow:0 3px 19px #0002;min-width:176px;max-width:220px;padding:13px 17px;color:#226451;}
    .recent-card b{font-size:1.02rem;}
    .recent-card .tag{border-radius:7px;padding:2.6px 12px;color:#fff;font-weight:700;margin:0 4px;}
    .recent-card .date{font-size:0.95rem;color:#949494;}
    /* Responsive */
    @media (max-width: 1080px) {.flex-row{flex-direction: column;} #liveMap{width:98vw;min-width: 260px;}}
    @media (max-width: 650px) {.home-flex,.flex-row{flex-direction:column;} .mapbox-home{width:98vw;} #liveMap{height:240px;}}
  </style>
</head>
<body>
<header>
  <div class="navbar">
    <span class="brand"><span class="logo">ðŸŒŠ</span> Water Health Index</span>
    <nav class="navlinks">
      <button class="navbtn active" data-tab="home">Home</button>
      <button class="navbtn" data-tab="measure">Measure</button>
      <button class="navbtn" data-tab="map">Map</button>
      <button class="navbtn" data-tab="phchart">pH Chart</button>
      <button class="navbtn" data-tab="care">Care</button>
      <button class="navbtn" data-tab="details">Details</button>
    </nav>
  </div>
</header>
<main>
  <div class="sections">
    <!-- Home tab -->
    <section class="tab active" data-tab="home">
      <div class="home-flex">
        <div class="welcome">
          <h1>Welcome to <span class="hl">Water Health Index</span></h1>
          <p>Discover, measure, and share water quality.<br>
            Fast, science-powered, and super easy â€” made for students and teams!</p>
          <button class="measure-btn" data-goto="measure">Start Measurement</button>
        </div>
        <div class="mapbox-home" id="homeMap"></div>
      </div>
      <div class="howto">
        <h2>How It Works</h2>
        <ol>
          <li>Enter your sample data: pH, temperature, turbidity.</li>
          <li>Scan your pH strip with the camera for precision.</li>
          <li>Pin your reading on the world map and observe global water health.</li>
        </ol>
        <p>Explore the <a href="#" class="tablink" data-goto="phchart">pH Chart</a> and <a href="#" class="tablink" data-goto="care">Care Tips</a>.</p>
      </div>
      <div class="recent-section">
        <h2 style="color:#43cea2;">Recent Shared Readings</h2>
        <div class="recent-list" id="recentList"></div>
      </div>
    </section>
    <!-- Measure tab -->
    <section class="tab" data-tab="measure">
      <div class="flex-row">
        <form class="measure-card" id="measureForm" autocomplete="off" onsubmit="return false">
          <label for="phInput">pH (0.0 - 14.0)</label>
          <input id="phInput" type="number" step="0.1" min="0" max="14" required placeholder="e.g., 7.2">
          <label for="tempInput">Temperature (Â°C)</label>
          <input id="tempInput" type="number" step="0.1" min="-5" max="60" required placeholder="e.g., 23.4">
          <label for="turbiditySelect">Turbidity</label>
          <select id="turbiditySelect" required>
            <option value="">Select turbidity</option>
            <option value="low">Low â€” Clear</option>
            <option value="medium">Medium â€” Cloudy</option>
            <option value="high">High â€” Muddy</option>
          </select>
          <div class="row">
            <button type="button" id="analyzeBtn">Calculate Index</button>
            <button type="button" id="cameraBtn">Open Camera</button>
          </div>
          <div id="cameraArea" style="display:none;">
            <video id="video" autoplay playsinline style="width:100%;border-radius:10px; margin-top:10px;"></video>
            <div class="row">
              <button type="button" id="captureBtn">Capture Color</button>
              <button type="button" id="closeCamBtn">Close Camera</button>
            </div>
            <div class="note" id="cameraNote">Align and hold your pH strip steady under good light!</div>
          </div>
          <div class="location-block">
            <button type="button" id="locBtn">Use My Location</button>
            <div class="note" id="locLabel">No location attached</div>
          </div>
          <div id="resultBlock" class="result" style="display:none;"></div>
          <div class="row">
            <button type="button" id="saveBtn">Save Reading</button>
          </div>
        </form>
        <div>
          <div id="liveMap"></div>
          <div class="map-legend">Latest readings appear here with location and health index.<br>
            <small>Green=Good, Yellow=Moderate, Red=Poor</small></div>
        </div>
      </div>
    </section>
    <!-- Map tab -->
    <section class="tab" data-tab="map">
      <h2 style="color:#43cea2;">All Measurements (Interactive Map)</h2>
      <div style="margin:30px 0;"><div id="bigMap" style="width:99%;max-width:900px;height:400px;border-radius:14px;margin:auto;border:2px solid #b1e4e9;"></div></div>
    </section>
    <!-- PH Chart tab -->
    <section class="tab" data-tab="phchart">
      <h2 style="color:#43cea2;">pH Chart</h2>
      <p>This section will visualize standard pH color ranges and what they mean for water health.<br>
      <b style="display:inline-block;margin-top:12px;">Coming soon!</b>
      </p>
    </section>
    <!-- Care tab -->
    <section class="tab" data-tab="care">
      <h2 style="color:#43cea2;">Water Care Tips</h2>
      <ul>
        <li>Keep water sources free of litter and industrial waste.</li>
        <li>Avoid letting detergents or chemicals reach natural water.</li>
        <li>Plant trees and shrubs along riverbanks to reduce erosion.</li>
        <li><b>More best-practices and restoration guides coming soon.</b></li>
      </ul>
    </section>
    <!-- Details tab -->
    <section class="tab" data-tab="details">
      <h2 style="color:#43cea2;">Project Details</h2>
      <p>Created for the National School Team Project.<br>
        Contributors: Your Names Here.<br>
        <b>Technologies used:</b> HTML, CSS, JavaScript, LeafletJS, OpenStreetMap, Browser Geolocation.<br>
        <b>Contact:</b> your_email@example.com
      </p>
    </section>
  </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ---- NAVIGATION ---- */
document.querySelectorAll('.navbtn').forEach(btn=>{
  btn.onclick = function(){
    document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    let tab = btn.dataset.tab;
    document.querySelectorAll('.tab').forEach(sec=>{
      sec.classList.remove('active');
      if(sec.dataset.tab===tab) sec.classList.add('active');
    });
    window.scrollTo(0,0);
    if(tab==='map' && window.bigMap) setTimeout(()=>window.bigMap.invalidateSize(),100);
  };
});
// in-section links
document.querySelectorAll('.tablink, .measure-btn').forEach(link=>{
  link.onclick = function(e){
    e.preventDefault();
    let tab = this.dataset.goto;
    document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
    document.querySelector('.navbtn[data-tab="'+tab+'"]').classList.add('active');
    document.querySelectorAll('.tab').forEach(sec=>{
      sec.classList.remove('active');
      if(sec.dataset.tab===tab) sec.classList.add('active');
    });
    if(tab==='map' && window.bigMap) setTimeout(()=>window.bigMap.invalidateSize(),100);
  }
});
/* ---- HOME MAP ---- */
var hmap = L.map('homeMap',{center:[20,0],zoom:2,attributionControl:0});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(hmap);
function addSampleMarkers(map,list){list.forEach(site=>{
  L.circleMarker([site.lat,site.lng],{radius:8,fillColor:site.idx>=80?'#2e7d32':site.idx>=50?'#f9a825':'#c62828',fillOpacity:0.83,color:'#0093E9',weight:1.3})
    .addTo(map)
    .bindPopup(`<b>${site.place}</b><br>Index: ${site.idx}${site.date?("<br>"+site.date):""}`);
});}
const exampleSites=[{lat:28.6,lng:77.2,idx:91,place:'Yamuna, India'},
{lat:40.7,lng:-74,idx:80,place:'Hudson, USA'},
{lat:-33.9,lng:151.2,idx:90,place:'Sydney, AUS'}];
addSampleMarkers(hmap,exampleSites);
/* -- RECENT HOME READINGS -- */
const recentList = document.getElementById('recentList');
function renderRecent(list){recentList.innerHTML='';
list.forEach(r=>{
let color=r.idx>=80?'#2e7d32':r.idx>=50?'#f9a825':'#c62828';
recentList.innerHTML+=`<div class="recent-card"><b>${r.place}</b><div>Index: <span class="tag" style="background:${color}">${r.idx}</span></div>${r.date?'<div class="date">'+r.date+'</div>':''}</div>`;
});}
renderRecent(exampleSites);

/* ---- MEASURE+MAP ---- */
// Utility
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
function scorePH(ph){const diff=Math.abs(ph-7.0);const penalty=7.5*Math.pow(diff,1.55);return clamp(100-penalty,0,100);}
function scoreTemp(t){if(isNaN(t))return 80;if(t>=20&&t<=26)return 100;if(t<20)return clamp(100-Math.pow(20-t,1.2)*4.5,0,100);return clamp(100-Math.pow(t-26,1.25)*5.5,0,100);}
function scoreTurb(t){if(t==='low')return 100;if(t==='medium')return 62;if(t==='high')return 28;return 50;}
function adviceFor(index){if(index>=95)return"Outstanding water quality!";if(index>=80)return"Very Good.";if(index>=60)return"Monitor regularly.";if(index>=40)return"Borderline, caution advised.";return "Poor water quality.";}
function reverseGeocode(lat,lng,cb){
fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`).then(r=>r.json())
.then(data=>cb(data.display_name||`${lat.toFixed(3)},${lng.toFixed(3)}`)).catch(()=>cb(`${lat.toFixed(3)},${lng.toFixed(3)}`));
}
const readings = [];
let mapLive=null,mapMarkers=[];
function addMarker(r){
  if(!mapLive)return;
  let marker=L.circleMarker([r.lat,r.lng],{
    radius:9,
    fillColor:r.idx>=80?'#2e7d32':r.idx>=50?'#f9a825':'#c62828',fillOpacity:0.85,color:'#0093e9',weight:1.1
  }).addTo(mapLive).bindPopup(`<b>${r.place||''}</b><br>Index: ${r.idx}<br>pH: ${r.ph}<br>Temp: ${r.temp}<br>Turbidity: ${r.turb}`);
  mapMarkers.push(marker);
}
function renderLiveMap(){if(mapLive)return;
mapLive=L.map('liveMap',{center:[20,0],zoom:2,attributionControl:0});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(mapLive);}
renderLiveMap();
// --- Form logic
const phInput=document.getElementById('phInput'),tempInput=document.getElementById('tempInput'),turbiditySelect=document.getElementById('turbiditySelect');
const analyzeBtn=document.getElementById('analyzeBtn'),resultBlock=document.getElementById('resultBlock');
const locBtn=document.getElementById('locBtn'),locLabel=document.getElementById('locLabel');
const saveBtn=document.getElementById('saveBtn');
let readingPlace='',readingCoords=null;
// Camera logic
const cameraBtn=document.getElementById('cameraBtn'),cameraArea=document.getElementById('cameraArea');
const video=document.getElementById('video'),captureBtn=document.getElementById('captureBtn'),closeCamBtn=document.getElementById('closeCamBtn');
let mediaStream=null;
function openCamera(){navigator.mediaDevices.getUserMedia({video:true})
  .then(s=>{mediaStream=s;video.srcObject=s;cameraArea.style.display='block';})
  .catch(()=>alert('Camera not available or allowed.'));}
function closeCamera(){mediaStream&&mediaStream.getTracks().forEach(t=>t.stop());video.srcObject=null;cameraArea.style.display='none';}
cameraBtn.onclick=openCamera;closeCamBtn.onclick=closeCamera;
captureBtn.onclick=()=>{
  if(!mediaStream)return;
  let c=document.createElement('canvas'),w=video.videoWidth,h=video.videoHeight;
  c.width=w;c.height=h;let ctx=c.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  let d=ctx.getImageData(w/2-15,h/2-15,30,30).data,r=0,g=0,b=0,count=0;
  for(let i=0;i<d.length;i+=4){r+=d[i];g+=d[i+1];b+=d[i+2];count++;}
  r=Math.round(r/count);g=Math.round(g/count);b=Math.round(b/count);
  function estimatePH(r,g,b){
    const mx=Math.max(r,g,b),mn=Math.min(r,g,b),diff=mx-mn;
    let hue=0; if(diff===0)hue=0;else if(mx===r)hue=(60*((g-b)/diff)+360)%360;
    else if(mx===g)hue=(60*((b-r)/diff)+120)%360;else  hue=(60*((r-g)/diff)+240)%360;
    let ph=7;if(hue>=330||hue<=30)ph=3+(30-Math.abs(hue<=30?hue:360-hue))/30*2;
    else if(hue>30&&hue<=80)ph=5+(80-hue)/50*2;
    else if(hue>80&&hue<=160)ph=7+(160-hue)/80*1.2;
    else if(hue>160&&hue<=260)ph=8.5+(260-hue)/100*2.5;
    return clamp(Math.round(ph*100)/100,0,14);
  }
  let estPH=estimatePH(r,g,b);
  phInput.value=estPH;
  document.getElementById('cameraNote').textContent=`Detected color: R${r} G${g} B${b} â†’ pH â‰ˆ ${estPH}`;
};
// -- Geolocation logic
locBtn.onclick=()=>{
  locLabel.textContent='Getting location...';
  navigator.geolocation.getCurrentPosition(pos=>{
    readingCoords={lat:pos.coords.latitude,lng:pos.coords.longitude};
    reverseGeocode(pos.coords.latitude,pos.coords.longitude,function(name){
      readingPlace=name;locLabel.textContent=name;
    });
  },()=>{locLabel.textContent='Location denied/unavailable.';});
};
// -- Analyze/Compute
analyzeBtn.onclick=function(){
  let pH=parseFloat(phInput.value),temp=parseFloat(tempInput.value),turb=turbiditySelect.value;
  if(isNaN(pH)||isNaN(temp)||!turb){alert('Enter all values.');return;}
  let idxRaw=scorePH(pH)*0.5+scoreTemp(temp)*0.25+scoreTurb(turb)*0.25;
  idxRaw=clamp(Math.round(idxRaw),0,100);
  resultBlock.style.display='block';
  resultBlock.innerHTML=`Index: <b>${idxRaw}</b> <span style="color:#2e7d32;">${adviceFor(idxRaw)}</span><br>
  <span class="tag" style="background:#b9d6f6;"> pH: ${pH} </span>
  <span class="tag" style="background:#ffe97f;color:#7b6b00;"> Temp: ${temp}Â°C </span>
  <span class="tag" style="background:#b2dfdb;color:#224642;"> ${turb} </span>`;
  resultBlock.idx=idxRaw;
};
saveBtn.onclick=function(){
  let pH=parseFloat(phInput.value),temp=parseFloat(tempInput.value),turb=turbiditySelect.value,idx=resultBlock.idx;
  if(isNaN(pH)||isNaN(temp)||!turb||idx==null){alert('Input, analyze, and geolocate first.');return;}
  if(!readingCoords||!readingPlace){alert("Attach location first.");return;}
  let r={ph:pH,temp:temp,turb:turb,idx:idx,lat:readingCoords.lat,lng:readingCoords.lng,place:readingPlace,date:new Date().toLocaleDateString()};
  readings.push(r);addMarker(r);
  // Add to map tab if present
  if(window.bigMap) L.circleMarker([r.lat,r.lng],{radius:9,fillColor:r.idx>=80?'#2e7d32':r.idx>=50?'#f9a825':'#c62828',fillOpacity:0.85,color:'#0093e9',weight:1.1})
    .addTo(window.bigMap).bindPopup(`<b>${r.place||''}</b><br>Index: ${r.idx}<br>pH: ${r.ph}<br>Temp: ${r.temp}<br>Turbidity: ${r.turb}`);
  alert("Reading saved and plotted on map!");
};
// Show liveMap on tab, handle invalidation
let initedMapTab=false;
document.querySelector('.navbtn[data-tab="map"]').onclick=function(){
  document.querySelectorAll('.navbtn').forEach(b=>b.classList.remove('active'));
  this.classList.add('active');
  document.querySelectorAll('.tab').forEach(sec=>{
    sec.classList.remove('active');
    if(sec.dataset.tab==='map') sec.classList.add('active');
  });
  setTimeout(()=>{
    if(!window.bigMap){
      window.bigMap=L.map('bigMap',{center:[20,0],zoom:2});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(window.bigMap);
    }
    window.bigMap.invalidateSize();
    // Render all points
    readings.concat(exampleSites).forEach(r=>{
      L.circleMarker([r.lat,r.lng],{radius:9,fillColor:r.idx>=80?'#2e7d32':r.idx>=50?'#f9a825':'#c62828',fillOpacity:0.85,color:'#0093e9',weight:1.1})
        .addTo(window.bigMap).bindPopup(`<b>${r.place||''}</b><br>Index: ${r.idx}<br>pH: ${r.ph}<br>Temp: ${r.temp}${r.turb?`<br>Turbidity: ${r.turb}`:''}`);
    });
  },100);
};
</script>
</body>
</html>
